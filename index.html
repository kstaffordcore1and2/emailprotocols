<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Authentication Flow: DNS, SMTP, SPF, DKIM, DMARC Interactive</title>
    <style>
        /* Retro/AOL-inspired theme */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, Arial, sans-serif;
            line-height: 1.6;
            color: #152238; /* deep indigo text */
            margin: 20px;
            padding: 0;
            background-color: #0b57a4; /* fallback blue */
            /* Use the provided local image (placed next to this HTML file). */
            background-image: url('aoldesktop2.jpg');
            background-repeat: no-repeat;
            background-position: center top;
            /* Show the full image where possible so users can see more of it */
            background-size: contain;
            /* allow the page to scroll normally so the image resizes with the browser */
            background-attachment: scroll;
        }

        /* Main content card with slight translucency so background shows through */
        .container {
            max-width: 1000px;
            margin: 30px auto;
            background-color: rgba(255,255,255,0.92);
            padding: 28px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(6,24,64,0.45);
            border-top: 6px solid #0066CC; /* AOL blue */
            backdrop-filter: blur(2px);
        }

        h1 {
            color: #002a75; /* deep AOL blue */
            text-align: center;
            margin-bottom: 26px;
            font-size: 2.4em;
            font-weight: 800;
            letter-spacing: 0.5px;
            text-shadow: 0 1px 0 rgba(255,255,255,0.6), 0 3px 8px rgba(0,0,0,0.12);
        }

        .flow-diagram {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 22px;
            padding: 18px 0;
        }

        .step {
            background-color: rgba(255,250,230,0.95); /* soft cream */
            border: 1px solid rgba(0,0,0,0.06);
            border-left: 6px solid #0066CC; /* AOL blue accent */
            padding: 18px 22px;
            border-radius: 8px;
            width: 82%;
            max-width: 720px;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
            cursor: pointer;
            transition: transform 0.22s ease, box-shadow 0.22s ease, background-color 0.22s ease;
        }

        .step:hover {
            transform: translateY(-6px);
            box-shadow: 0 14px 30px rgba(0, 0, 0, 0.18);
            background-color: rgba(255,255,240,0.98);
        }

        .step-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 1.22em;
            font-weight: 700;
            color: #003399; /* darker indigo for headings */
            margin-bottom: 8px;
        }

        .step-header span:first-child {
            display: flex;
            align-items: center;
        }

        .step-header .icon {
            margin-right: 10px;
            font-size: 1.4em;
            filter: drop-shadow(0 1px 0 rgba(255,255,255,0.8));
        }

        .step-content {
            display: none;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px dashed rgba(0,86,204,0.12);
            color: #20374a;
            font-size: 0.95em;
        }

        .step.active .step-content {
            display: block;
        }

        .step.active {
            background-color: rgba(245,251,255,0.96);
            border-color: rgba(0,102,204,0.9);
            box-shadow: 0 16px 36px rgba(4,18,64,0.18);
        }

        .arrow {
            font-size: 2em;
            color: #003399;
            animation: bounce 1s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(6px); }
        }

        .toggle-icon {
            font-size: 1.2em;
            color: #0066CC;
        }

        .step.active .toggle-icon::before { content: '‚ñ≤'; }
        .step:not(.active) .toggle-icon::before { content: '‚ñº'; }

        /* Specific styling for the 'Failure Modes' section (keeps warning cue but tuned to palette) */
        #step-failure {
            background-color: rgba(255,243,245,0.95);
            border-left-color: #d81b60; /* magenta-ish warning */
        }

        #step-failure .step-header { color: #b0003a; }

        #step-failure:hover { background-color: rgba(255,233,239,0.96); }

        footer {
            text-align: center;
            margin-top: 50px;
            font-size: 0.9em;
            color: #0b2b4a;
        }

        /* GAME-SPECIFIC STYLES (AOL-inspired buttons) */
        .dmarc-game {
            max-width: 600px;
            margin: 50px auto;
            padding: 26px;
            border: 2px solid rgba(0,51,153,0.85); /* deep AOL indigo */
            border-radius: 10px;
            background: linear-gradient(180deg, rgba(232,238,246,0.95), rgba(216,230,255,0.9));
            box-shadow: 0 8px 30px rgba(4,18,64,0.25);
        }
        .dmarc-game h2 {
            color: #003399;
            text-align: center;
            margin-bottom: 18px;
            font-size: 1.75em;
            text-shadow: 0 1px 0 rgba(255,255,255,0.7);
        }
        #scenario, #policy-info {
            font-size: 1.05em;
            margin-bottom: 16px;
            padding: 12px;
            border-radius: 6px;
            background-color: rgba(255,255,255,0.85);
            text-align: center;
            border: 1px solid rgba(0,51,153,0.08);
            min-height: 48px; /* Ensure space for the question */
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        #policy-info {
            font-size: 0.9em;
            opacity: 0.8;
            margin-bottom: 20px;
        }

        /* Glossy AOL-esque option buttons */
        .options button {
            display: block;
            width: 100%;
            padding: 14px 16px;
            margin: 10px 0;
            font-size: 1.05em;
            cursor: pointer;
            border: 1px solid rgba(0,38,102,0.95);
            border-radius: 6px;
            transition: transform 0.08s ease, box-shadow 0.12s ease;
            background: linear-gradient(180deg,#1e62d0 0%, #0a47a3 60%, #083b8a 100%);
            color: #fff9dc; /* pale warm yellow for high contrast */
            text-shadow: 0 1px 0 rgba(0,0,0,0.18);
            font-weight: 700;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.28), 0 4px 10px rgba(6,24,64,0.22);
            text-align: left; /* Keep text left-aligned for clear A/B/C list */
        }
        /* Style for definition option buttons */
        .definition-options button {
            font-size: 0.95em;
            padding: 12px;
        }

        .options button:hover {
            transform: translateY(-3px);
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.32), 0 10px 20px rgba(6,24,64,0.26);
            color: #fffde0;
        }
        .options button:disabled {
            opacity: 0.6;
            transform: none;
            box-shadow: none;
            filter: grayscale(10%);
            cursor: default;
        }

        #result {
            text-align: center;
            margin-top: 22px;
            padding: 14px;
            border-radius: 6px;
            min-height: 46px;
            font-weight: 800;
            font-size: 1.12em;
            color: #05204a;
            border: 1px solid rgba(0,0,0,0.06);
            background: rgba(255,255,255,0.9);
            box-shadow: 0 6px 18px rgba(6,24,64,0.08);
        }
        .correct {
            background: linear-gradient(180deg,#e6f7ea, #c9efd0);
            color: #0b4d13;
            border: 1px solid #2e7d32;
        }
        .incorrect {
            background: linear-gradient(180deg,#ffecec, #ffd6d6);
            color: #7a1212;
            border: 1px solid #d32f2f;
        }

        #next-button {
            display: none;
            width: 100%;
            padding: 12px;
            margin-top: 12px;
            background: linear-gradient(180deg,#ffda44 0%, #ffbf00 60%);
            color: #08284a;
            border: 1px solid rgba(0,0,0,0.12);
            border-radius: 6px;
            font-size: 1.02em;
            font-weight: 800;
            cursor: pointer;
            box-shadow: 0 6px 16px rgba(4,18,64,0.12), inset 0 1px 0 rgba(255,255,255,0.5);
        }
        #next-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 26px rgba(4,18,64,0.16);
        }

        /* Focus outlines for keyboard users */
        .options button:focus, #next-button:focus { outline: 3px solid rgba(0,102,204,0.22); }
    </style>
</head>
<body>

    <div class="container">
        <h1>üìß Email Authentication Flow: DNS, SMTP, SPF, DKIM, DMARC</h1>
        <p style="text-align: center; margin-bottom: 30px; font-size: 1.1em; color: #555;">
            Click on each step to reveal details about how these protocols work together to secure email communication.
        </p>

        <div class="flow-diagram">

            <div class="step" id="step-smtp">
                <div class="step-header">
                    <span><span class="icon">üöÄ</span> 1. The Send (SMTP)</span>
                    <span class="toggle-icon"></span>
                </div>
                <div class="step-content">
                    <p><strong>What it is:</strong> SMTP (Simple Mail Transfer Protocol) is the fundamental set of rules that allows mail servers to **send** and **relay** email across the internet.</p>
                    <p><strong>How it starts:</strong> When a user clicks send, the local server initiates the process using SMTP to communicate with the recipient's server.</p>
                    <p><strong>The Flaw:</strong> SMTP does not verify who the sender really is, which makes spoofing possible.</p>
                    <p><strong>Analogy:</strong> SMTP is the **delivery truck**. It transports the mail but doesn't inherently check the driver's ID.</p>
                </div>
            </div>

            <div class="arrow">‚Üì</div>

            <div class="step" id="step-mx">
                <div class="step-header">
                    <span><span class="icon">üó∫Ô∏è</span> 2. The Destination (MX Record)</span>
                    <span class="toggle-icon"></span>
                </div>
                <div class="step-content">
                    <p><strong>What it is:</strong> The MX (Mail Exchanger) DNS record is a directional signpost that tells the internet **which server** is responsible for accepting email for a specific domain.</p>
                    <p><strong>How it works:</strong> Before sending the email, the sender's server queries the recipient's DNS to find the MX record. This record provides the address of the recipient's mail server (e.g., Google's server for a Google Workspace domain) and a priority ranking.  ***If multiple MX records exist, the one with the lowest number has the highest priority***</p>
                    <p><strong>The Role:</strong> This step ensures the email is directed to the correct digital mailbox before any security checks can even begin.</p>
                    <p><strong>Analogy:</strong> The MX record is the **Mail Carrier's Address Book**. It tells the delivery truck (SMTP) the exact service door to drop off the mail at the recipient's domain.</p>
                </div>
            </div>

            <div class="arrow">‚Üì</div>

            <div class="step" id="step-txt">
                <div class="step-header">
                    <span><span class="icon">üìÇ</span> 3. The Policy Source (TXT Record)</span>
                    <span class="toggle-icon"></span>
                </div>
                <div class="step-content">
                    <p><strong>What it is:</strong> The TXT (Text) DNS record is a general-purpose record used to store arbitrary text. It is the designated storage method for all email authentication policies. Not for sending/receiving emails--it just stores authentication rules.</p>
                    <p><strong>How it works:</strong> The recipient's mail server (identified by the MX record) starts querying the sender's domain using TXT records to retrieve the specific security instructions for SPF, DKIM, and DMARC.</p>
                    <p><strong>The Role:</strong> Without TXT records, the authentication checks cannot occur because the recipient server would have no policy information to enforce.</p>
                    <p><strong>Analogy:</strong> The TXT record is the **Official Policy File Cabinet**. It doesn't perform the check itself, but it holds the rulebooks (SPF, DKIM, DMARC) that the receiving server will use.</p>
                </div>
            </div>
            
            <div class="arrow">‚Üì</div>

            <div class="step" id="step-spf">
                <div class="step-header">
                    <span><span class="icon">üìã</span> 4. SPF: Sender Policy Framework</span>
                    <span class="toggle-icon"></span>
                </div>
                <div class="step-content">
                    <p><strong>What it is:</strong> A public policy (stored in a TXT record) listing all IP addresses (mail servers) that are **authorized** to send email for your domain.</p>
                    <p><strong>How it works:</strong> The recipient server checks the sending IP address against your domain's SPF record---it does not check the message content. If the IP is on the list, the email passes the SPF check.</p>
                    <p><strong>For Google Workspace:</strong> Your record must contain <code>include:_spf.google.com</code> to authorize Google's sending servers.</p>
                    <p><strong>Analogy:</strong> SPF is the **bouncer at the door with a guest list**. "Is this sender's IP address on the approved list for <code>yourdomain.edu</code>?"</p>
                </div>
            </div>

            <div class="arrow">‚Üì</div>

            <div class="step" id="step-dkim">
                <div class="step-header">
                    <span><span class="icon">‚úçÔ∏è</span> 5. DKIM: DomainKeys Identified Mail</span>
                    <span class="toggle-icon"></span>
                </div>
                <div class="step-content">
                    <p><strong>What it is:</strong> A **cryptographic digital signature** added to the email header. It verifies the email was genuinely authorized by the domain owner and that the message content hasn't been altered during transport.</p>
                    <p><strong>How it works:</strong> The recipient server uses a **public key** (published in a TXT record) to decrypt and verify the signature applied by the sender's **private key**.</p>
                    <p><strong>Key Check:</strong> "Does the signature match, proving authenticity, and is the content unchanged?"</p>
                    <p><strong>Analogy:</strong> DKIM is the **tamper-proof seal and official signature** on a document. It verifies the document's integrity and source.</p>
                </div>
            </div>

            <div class="arrow">‚Üì</div>

            <div class="step" id="step-dmarc">
                <div class="step-header">
                    <span><span class="icon">üö¶</span> 6. DMARC: Policy & Alignment</span>
                    <span class="toggle-icon"></span>
                </div>
                <div class="step-content">
                    <p><strong>What it is:</strong> DMARC (Domain-based Message Authentication, Reporting & Conformance) connects the results of SPF and DKIM and enforces a policy (also stored in a TXT record). It also sends reports back to the domain owner so they can see who is trying to send mail using their domain</p>
                    <p><strong>Alignment:</strong> DMARC is essential because it requires the visible **"From" address** to align with the domain validated by either SPF or DKIM. This is the final defense against domain spoofing.</p>
                    <p><strong>The Policy (`p=`):</strong> This tag tells the recipient server what to do if the email fails the alignment check:</p>
                    <ul>
                        <li><code>p=none</code>: Monitor and send reports. (No blocking)</li>
                        <li><code>p=quarantine</code>: Send to the recipient's **spam folder**.</li>
                        <li><code>p=reject</code>: **Block/bounce** the email completely.</li>
                    </ul>
                    <p><strong>Analogy:</strong> DMARC is the **traffic cop and rulebook**. It makes sure the identities match and dictates the punishment (quarantine or reject) if they don't.</p>
                </div>
            </div>

            <div class="arrow">‚Üì</div>

            <div class="step" id="step-outcome" style="background-color: #e8f5e9; border-left-color: #388e3c;">
                <div class="step-header" style="color: #2e7d32;">
                    <span><span class="icon">‚úÖ</span> 7. The Outcome</span>
                    <span class="toggle-icon"></span>
                </div>
                <div class="step-content">
                    <p>If the email **Passes** the DMARC Alignment check (meaning SPF or DKIM succeeded and aligned), it is considered legitimate and delivered to the recipient's inbox.</p>
                    <p>If the email **Fails** DMARC, the recipient mail server enforces the sender's stated policy (Quarantine or Reject), protecting the recipient from impersonation.</p>
                </div>
            </div>

            <div class="arrow">‚Üì</div>

            <div class="step" id="step-failure">
                <div class="step-header">
                    <span><span class="icon">‚ö†Ô∏è</span> 8. How Spoofed Emails Can Still Pass (Failure Modes)</span>
                    <span class="toggle-icon"></span>
                </div>
                <div class="step-content">
                    <p>Even with SPF, DKIM, and DMARC fully configured, some spoofing tactics can still succeed, requiring users to remain vigilant:</p>
                    <ul>
                        <li><strong>DMARC Set to `p=none`:</strong> The most common reason. If the domain owner hasn't set their DMARC policy to `quarantine` or `reject`, receiving servers are simply told to monitor the spoofed email, and they often deliver it anyway.</li>
                        <li>**"Friendly From" Spoofing (Display Name Attack):** A scammer uses a completely different, unauthenticated domain, but sets the visible display name to match a legitimate one (e.g., the email address is `scammer@notyourdomain.com` but the name shown is **"Principal Smith"**). The security checks only look at the domain, not the display name.</li>
                        <li>**Phishing via Look-Alike Domains (Typosquatting):** The scammer registers a domain that is visually similar to yours (e.g., `y0urdomain.edu` instead of `yourdomain.edu`). Since this is technically a different, unauthenticated domain, SPF/DKIM/DMARC for *your* domain are not even checked.</li>
                        <li>SPF, DKIM, and DMARC only protect your domain. They cannot stop attackers from using other domains.‚Äù This closes the loop on student misconceptions.</li>
                    </ul>
                </div>
            </div>

        </div>
    </div>

<div class="dmarc-game">
    <h2>üö¶ Email Delivery Checkpoint üö¶</h2>
    
    <div id="scenario"></div>
    <div id="policy-info"></div>

    <div class="options" id="options">
        <!-- Buttons will be dynamically generated by JavaScript -->
    </div>

    <div id="result">Click an option to see the result.</div>

    <button id="next-button" onclick="loadNextScenario()">Next Scenario</button>
</div>

    <script>
        // Utility function to shuffle an array
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // --- Audio: play a "you've got mail" sound on first user click,
        // and an "AOL goodbye" sound when the user answers the DMARC question.
        const audioFirstClick = new Audio('youve_got_mail.mp3');
        const audioDmarc = new Audio('aol_goodbye.mp3');

        // Flags to track whether sounds have been played
        let firstClickPlayed = false;
        let dmarcPlayed = false;

        // Play the first-click sound once on the first user click (satisfies
        // browser gesture requirement for audio playback).
        document.addEventListener('click', () => {
            if (!firstClickPlayed) {
                firstClickPlayed = true;
                try {
                    audioFirstClick.currentTime = 0;
                    const p = audioFirstClick.play();
                    if (p && p.catch) p.catch(() => {});
                } catch (e) { /* ignore */ }
            }
        }, { once: false });

        const definitionScenarios = [
            {
                name: "Definition Check 1/6: The Delivery Truck",
                type: "definition",
                question: "Which **fundamental protocol** establishes the connection between mail servers and is responsible for *sending* and *relaying* the email?",
                answer: "SMTP",
                explanation: "Correct! **SMTP (Simple Mail Transfer Protocol)** is the low-level standard for moving mail across the internet."
            },
            {
                name: "Definition Check 2/6: Mail Server Address",
                type: "definition",
                question: "Which DNS record acts as the **directional signpost**, telling the sending server the exact address of the recipient's mail server?",
                answer: "MX",
                explanation: "Correct! The **MX (Mail Exchanger)** record is essential; without it, the sender's server wouldn't know where to deliver the email."
            },
            {
                name: "Definition Check 3/6: Policy Storage",
                type: "definition",
                question: "Which DNS record type is used as a **general-purpose storage** for security policies like SPF, DKIM, and DMARC?",
                answer: "TXT",
                explanation: "Correct! **TXT** records are used to publish all the text-based policies that the recipient server will query for authentication checks."
            },
            {
                name: "Definition Check 4/6: Authorized IP List",
                type: "definition",
                question: "Which protocol is the **'guest list'** that explicitly authorizes which specific IP addresses (mail servers) can send mail for a domain?",
                answer: "SPF",
                explanation: "Correct! **SPF (Sender Policy Framework)** checks if the sending server's IP is on the authorized list published by the domain owner."
            },
            {
                name: "Definition Check 5/6: The Tamper-Proof Seal",
                type: "definition",
                question: "Which protocol adds a **cryptographic digital signature** to the email header to verify integrity and prove authorization by the domain owner?",
                answer: "DKIM",
                explanation: "Correct! **DKIM (DomainKeys Identified Mail)** uses a public/private key pair to create a tamper-proof seal on the email content."
            },
            {
                name: "Definition Check 6/6: The Traffic Cop",
                type: "definition",
                question: "Which protocol determines the final action (reject, quarantine, or none) for a failing email and requires the visible 'From' address to **align** with the authentication results?",
                answer: "DMARC",
                explanation: "Correct! **DMARC (Domain-based Message Authentication, Reporting & Conformance)** is the final authority, enforcing the policy based on SPF and DKIM alignment."
            }
        ];

        const deliveryScenarios = [
             { 
                name: "Delivery Check 1/6: MX Record Missing", 
                type: "delivery",
                mx_status: "FAIL (No MX Record found)", 
                txt_status: "N/A", 
                spf: "N/A", 
                dkim: "N/A", 
                policy: "reject", 
                answer: "REJECT", 
                explanation: "This is a fundamental failure! The sender's server could not even determine *where* to send the mail. Without a valid **MX record** (The Mail Carrier's Address Book), the entire process stops, and the email is **rejected** before any authentication checks begin." 
            },
            { 
                name: "Delivery Check 2/6: Policy File Missing", 
                type: "delivery",
                mx_status: "PASS", 
                txt_status: "FAIL (No DMARC TXT Record found)", 
                spf: "FAIL", 
                dkim: "FAIL", 
                policy: "none (default)", 
                answer: "DELIVER", 
                explanation: "If the recipient server finds no DMARC **TXT record** (The Official Policy File Cabinet), it cannot enforce a policy. By default, the delivery falls back to **'none'**, allowing the unauthenticated email to be **delivered** (but often still tagged as suspicious)." 
            },
            { 
                name: "Delivery Check 3/6: Valid Sender", 
                type: "delivery",
                mx_status: "PASS", 
                txt_status: "PASS", 
                spf: "PASS (IP authorized)", 
                dkim: "FAIL (Bad Signature)", 
                policy: "quarantine", 
                answer: "DELIVER", 
                explanation: "Since **DMARC only requires ONE** of the checks (SPF or DKIM) to pass and align, the SPF pass is enough to validate the email. It is **delivered**, despite the DKIM failure." 
            },
            { 
                name: "Delivery Check 4/6: Policy Enforced (Strict)", 
                type: "delivery",
                mx_status: "PASS", 
                txt_status: "PASS",
                spf: "FAIL", 
                dkim: "FAIL", 
                policy: "reject", 
                answer: "REJECT", 
                explanation: "Both SPF and DKIM failed, meaning the sender is unauthorized. The strict DMARC policy of 'reject' is enforced, causing the email to **bounce**." 
            },
            { 
                name: "Delivery Check 5/6: Monitoring Mode", 
                type: "delivery",
                mx_status: "PASS", 
                txt_status: "PASS",
                spf: "FAIL", 
                dkim: "FAIL", 
                policy: "none", 
                answer: "DELIVER", 
                explanation: "Authentication failed, but the 'none' policy instructs the receiving server to simply monitor and **deliver** the email, which is why 'none' is the least secure setting!" 
            },
            { 
                name: "Delivery Check 6/6: The Soft Failure", 
                type: "delivery",
                mx_status: "PASS", 
                txt_status: "PASS",
                spf: "FAIL", 
                dkim: "FAIL", 
                policy: "quarantine", 
                answer: "QUARANTINE", 
                explanation: "Both authentication checks failed. The DMARC policy of 'quarantine' is enforced, sending the email to the **spam folder**." 
            }
        ];
        
        const allScenarios = definitionScenarios.concat(deliveryScenarios);

        let currentScenarioIndex = 0;
        let isAnswered = false;

        // --- Options Definitions ---
        // We'll randomize the option order once per page load so every refresh
        // presents randomized options consistently during that session.
        const termOptions = shuffleArray(['SMTP', 'MX', 'TXT', 'SPF', 'DKIM', 'DMARC']);
        const deliveryOptions = shuffleArray([
            { code: 'DELIVER', text: 'Deliver to Inbox' },
            { code: 'QUARANTINE', text: 'Send to Spam/Quarantine' },
            { code: 'REJECT', text: 'Reject/Bounce the Email' }
        ]);

        // --- DOM Elements ---
        const scenarioDiv = document.getElementById('scenario');
        const policyInfoDiv = document.getElementById('policy-info');
        const resultDiv = document.getElementById('result');
        const optionsDiv = document.getElementById('options');
        const nextButton = document.getElementById('next-button');
    const gameHeading = document.querySelector('.dmarc-game h2');

        // Helper to get the full descriptive text for a delivery answer code
        function getOptionText(answerCode) {
            const option = deliveryOptions.find(opt => opt.code === answerCode);
            return option ? option.text : "Unknown Action";
        }


        function loadScenario(index) {
            if (index >= allScenarios.length) {
                scenarioDiv.innerHTML = "You completed the challenge! Refresh the page to play again.";
                policyInfoDiv.innerHTML = "";
                optionsDiv.style.display = 'none';
                nextButton.style.display = 'none';
                resultDiv.innerHTML = "Great job!";
                resultDiv.className = 'correct';
                return;
            }

            const scenario = allScenarios[index];
            // Update the visible game heading based on the current scenario type
            // and do not trigger audio here. DMARC audio will play only when the
            // user answers the final DMARC Challenge question (handled in checkAnswer()).
            if (scenario.type === 'definition') {
                if (gameHeading) gameHeading.textContent = 'Email Delivery Checkpoint';
            } else {
                if (gameHeading) gameHeading.textContent = 'DMARC Challenge Game';
            }
            isAnswered = false;
            optionsDiv.innerHTML = '';
            
            const prefixes = ['A', 'B', 'C', 'D', 'E', 'F'];

            // --- Set up Scenario Display and Options ---
            if (scenario.type === 'definition') {
                policyInfoDiv.innerHTML = `Quiz: Identify the Protocol or DNS Record`;
                scenarioDiv.innerHTML = `<span style="font-weight:700;">Question:</span> ${scenario.question}`;
                
                optionsDiv.classList.add('definition-options');
                
                // Use the pre-shuffled termOptions (shuffled once at page load)
                const displayTermOptions = [...termOptions];

                displayTermOptions.forEach((term, idx) => {
                    const button = document.createElement('button');
                    button.textContent = `${prefixes[idx]}. ${term}`;
                    button.dataset.code = term; // Use data attribute for the answer code
                    button.onclick = () => checkAnswer(term);
                    optionsDiv.appendChild(button);
                });

            } else { // Delivery Type Scenario
                optionsDiv.classList.remove('definition-options');
                
                // Build the scenario information display
                let checkResults = `
                    <strong>Pre-Checks (MX & TXT):</strong> 
                    <br>MX Status: <strong>${scenario.mx_status}</strong> 
                    <br>TXT/Policy Status: <strong>${scenario.txt_status}</strong>
                `;

                // Only show SPF/DKIM if pre-checks allow the flow to proceed
                if (scenario.mx_status.includes("PASS")) {
                     checkResults += `
                        <br>---
                        <br><strong>Authentication Checks (SPF & DKIM):</strong>
                        <br>SPF Check: <strong>${scenario.spf}</strong> 
                        <br>DKIM Check: <strong>${scenario.dkim}</strong>
                    `;
                }
                
                scenarioDiv.innerHTML = checkResults;
                policyInfoDiv.innerHTML = `The domain's DMARC Policy is set to: <strong>p=${scenario.policy}</strong>. What happens to the email?`;

                // Use the pre-shuffled deliveryOptions (shuffled once at page load)
                const displayDeliveryOptions = [...deliveryOptions];

                displayDeliveryOptions.forEach((option, idx) => {
                    const button = document.createElement('button');
                    // Add dynamic prefix (A, B, C)
                    button.textContent = `${prefixes[idx]}. ${option.text}`; 
                    button.dataset.code = option.code; // Use data attribute for the answer code
                    button.onclick = () => checkAnswer(option.code);
                    optionsDiv.appendChild(button);
                });
            }
            
            resultDiv.innerHTML = "Click an option to see the result.";
            resultDiv.className = '';
            nextButton.style.display = 'none';
            optionsDiv.style.display = 'block';
        }

        function checkAnswer(userAnswer) {
            if (isAnswered) return;
            isAnswered = true;
            
            const scenario = allScenarios[currentScenarioIndex];
            const correctAnswer = scenario.answer;
            
            // Disable all buttons and highlight the correct one using the data-code attribute
            Array.from(optionsDiv.querySelectorAll('button')).forEach(btn => {
                btn.disabled = true;
                
                // Highlight the correct answer
                if (btn.dataset.code === correctAnswer) {
                    btn.style.backgroundColor = '#4CAF50';
                    btn.style.borderColor = '#388e3c';
                }
            });

            if (userAnswer === correctAnswer) {
                resultDiv.className = 'correct';
                resultDiv.innerHTML = `‚úÖ Correct! ${scenario.explanation}`;
            } else {
                resultDiv.className = 'incorrect';
                const correctOptionText = getOptionText(correctAnswer);
                resultDiv.innerHTML = `‚ùå Incorrect. The correct answer is **${correctOptionText}**. ${scenario.explanation}`;
            }

            // If this was the final DMARC Challenge question (the last delivery
            // scenario in the deliveryScenarios list), play the goodbye sound now.
            // We compute the scenario's index within the deliveryScenarios array
            // (safer than relying on the absolute position in allScenarios).
            const deliveryIndex = currentScenarioIndex - definitionScenarios.length;
            if (!dmarcPlayed && scenario.type === 'delivery' && deliveryIndex === deliveryScenarios.length - 1) {
                dmarcPlayed = true;
                try {
                    audioDmarc.currentTime = 0;
                    const p = audioDmarc.play();
                    if (p && p.catch) p.catch(() => {});
                } catch (e) { /* ignore */ }
            }

            nextButton.style.display = 'block';
        }

        function loadNextScenario() {
            currentScenarioIndex++;
            loadScenario(currentScenarioIndex);
        }

        document.querySelectorAll('.step').forEach(step => {
            step.addEventListener('click', () => {
                // Toggle active class on the clicked step
                step.classList.toggle('active');
            });
        });

        // Load the first scenario when the script runs
        window.onload = () => {
             loadScenario(currentScenarioIndex);
        };
       
    </script>

  <footer>
        <p>&copy; 2025 Email Authentication Explained. Designed for educational use.</p>
    </footer>

</body>
</html>
